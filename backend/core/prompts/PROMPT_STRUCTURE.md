# System Prompt Structure

## Overview
The system prompt is built dynamically by combining a base prompt with runtime-specific sections. This document explains where each part lives and how they're assembled.

## Prompt Assembly Flow

The prompt is built in `backend/core/run.py` in the `PromptManager.build_system_prompt()` method.

### Step 1: Base Prompt (Static)
**Location:** `backend/core/prompts/prompt_kv_cache.py`

Contains the core prompt content:
- Core identity & capabilities
- Mandatory workflow requirements
- Execution environment info
- Task management instructions (including detailed task tool usage)
- Communication guidelines
- Completion format
- Self-configuration info

**Function:** `get_system_prompt_kv_cache()` returns `SYSTEM_PROMPT_KV_CACHE`

### Step 2: Dynamic Additions (Runtime)
**Location:** `backend/core/run.py` - `build_system_prompt()` method

The base prompt is then extended with:

#### 2.1 Task-Specific Instructions (Auto-loaded)
- **When:** If task type is detected from user message
- **Source:** KV cache (`instruction_presentation`, `instruction_document_creation`, etc.)
- **Location:** Lines 472-492 in `run.py`
- **Format:** Injected as `# TASK-SPECIFIC INSTRUCTIONS (Auto-loaded)`

#### 2.2 Agent Custom System Prompt (Optional)
- **When:** If agent has custom `system_prompt` in config
- **Location:** Lines 504-507
- **Note:** Replaces base prompt if present

#### 2.3 Agent Builder Prompt (Conditional)
- **When:** If agent has builder tools enabled
- **Source:** `backend/core/prompts/agent_builder_prompt.py`
- **Location:** Lines 509-520
- **Function:** `get_agent_builder_prompt()`

#### 2.4 Knowledge Base Content (Conditional)
- **When:** If agent has knowledge base data
- **Source:** Database RPC call
- **Location:** Lines 522-551
- **Note:** Truncated to 5k chars max

#### 2.5 MCP Tools Info (Conditional)
- **When:** If agent has MCP servers configured
- **Location:** Lines 553-564
- **Format:** Compact tool count and usage note

#### 2.6 XML Tool Calling Instructions (Conditional)
- **When:** If `xml_tool_calling=True` and tool registry available
- **Location:** Lines 566-601
- **Contains:**
  - Tool calling format examples
  - Complete tool reference (all tools with schemas)
  - Generated by `_format_tools_for_xml()` method

#### 2.7 Date/Time Information (Always)
- **Location:** Lines 603-611
- **Format:** Current date, year, month, day

#### 2.8 KV Cache Instruction References (Always)
- **Source:** `backend/core/sandbox/instruction_seeder.py`
- **Location:** Lines 613-619
- **Function:** `get_all_instruction_references()`
- **Note:** Lists available instruction types in KV cache

#### 2.9 Adaptive Input Handling (Always)
- **Location:** Lines 621-644
- **Format:** Embedded string with guidance on handling mid-conversation user input

## Final Assembly

All sections are concatenated in order:
```
base_prompt
+ task_specific_instructions (if detected)
+ agent_custom_prompt (if exists, else base)
+ builder_prompt (if enabled)
+ knowledge_base (if exists)
+ mcp_info (if enabled)
+ xml_tool_instructions (if xml mode)
+ date_time_info
+ instruction_references
+ adaptive_input_guidance
```

## File Locations Summary

| Content | Location | Type |
|---------|----------|------|
| Base prompt | `prompt_kv_cache.py` | Static |
| Task tool instructions | `prompt_kv_cache.py` (section 5.1) | Static |
| Task-specific instructions | KV cache → `run.py` | Dynamic |
| Agent builder prompt | `agent_builder_prompt.py` | Static |
| Tool schemas | `run.py` (`_format_tools_for_xml()`) | Dynamic |
| Knowledge base | Database → `run.py` | Dynamic |
| MCP info | `run.py` | Dynamic |
| Date/time | `run.py` | Dynamic |
| Instruction refs | `instruction_seeder.py` → `run.py` | Dynamic |
| Adaptive input | `run.py` (embedded string) | Static |

## Key Functions

- `get_system_prompt_kv_cache()` - Returns base prompt
- `PromptManager.build_system_prompt()` - Assembles full prompt
- `PromptManager._format_tools_for_xml()` - Formats tool schemas
- `PromptManager._detect_task_type()` - Detects task from user message
- `PromptManager._load_instructions_for_task()` - Loads from KV cache

## Notes

- The base prompt in `prompt_kv_cache.py` contains the task tool instructions (section 5.1)
- Tool schemas are dynamically generated from the tool registry
- Task-specific instructions are only loaded when a task type is detected
- Most additions are conditional based on agent configuration

